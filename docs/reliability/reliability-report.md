# Звіт про надійність системи

## 1. Таблиця знайдених проблем

| № | Проблема | Fault | Error | Failure | Критичність | Статус |
| :-- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | Відсутній глобальний таймаут API | Відсутній `timeout` у `axios.create` | Запит зависає у pending | Інтерфейс блокується, користувач не отримує дані | **High** | ✅ Виправлено |
| 2 | Відсутній Error Boundary у React | Відсутній компонент-пастка винятків | Некеровані помилки в дочірніх компонентах | Весь UI падає при одній помилці | **High** |  ✅ **Виправлено** |
| 3 | Відсутня валідація `min` (ціна) | Не перевіряється мінімальне значення | У базі зберігаються нульові або від’ємні ціни | Помилки під час відображення або розрахунків | **Medium** |  ✅ **Виправлено** |
| 4 | Ризик зависання при оновленні токена | Немає таймауту у refresh-запиті | Сервер недоступний, запит не завершується | Авторизація зависає, користувач не може увійти | **High** | ✅ Виправлено |
| 5 | Відсутня обробка помилок завантаження зображень | Відсутній fallback або catch | Виняток при збоях завантаження | UI показує порожнє місце | **Low** | ✅ Виправлено (не існувала взагалі) |
| 6 | Занадто широке `except Exception` | Перехоплюються всі винятки | Реальна причина приховується | Неможливо визначити джерело проблеми | **Medium** | ❌ Не релевантно |
| 7 | Replace логіка без rollback у `update_dish` | Видаляються інгредієнти без перевірки нових | Тимчасово dish без ingredient-записів | Страва може залишитися без інгредієнтів | **High** | ⚠️ Відкрито |
| 8 | `accounts.views.LogoutView` | C — Валідація | Відсутня перевірка наявності `refresh`, можливий `KeyError` і 500 | Використано `request.data.get(...)` з чіткою 400-відповіддю для порожнього токена | ✅ Виправлено |
| 9 | `accounts.views.LogoutView` | A/D — Обробка помилок | Загальне `except Exception` приховувало неочікувані помилки | Перехоплюються тільки `TokenError`, інше підіймається для моніторингу | ✅ Виправлено |
| 10 | `create_initial_manager` команда | A/D — Обробка помилок | `except Exception` ковтав збої створення адміністратора | Винятки `IntegrityError/ValidationError` піднімаються, скрипт зупиняється з поясненням | ✅ Виправлено |
| 11 | `DishViewSet.get_queryset` | C — Валідація | `category_id` передавався рядком, некоректні значення падали в ORM | Додано приведення до `int` і явні 400-помилки для нечислових/негативних значень | ✅ Виправлено |
| 12 | `create_dish` сервіс | C/D — Валідація | Не перевірялися існування/дублікати інгредієнтів, `IntegrityError` → 500 | Валідація списку інгредієнтів перед записом, детальні `ValidationError` | ✅ Виправлено |
| 13 | `update_dish` сервіс | C/D — Валідація | Ті самі ризики при оновленні, можливий розрив транзакції | Та сама перевірка + транзакційний контекст `@transaction.atomic` | ✅ Виправлено |
| 14 | `ManagerUserCreateSerializer` | C — Валідація | Повторний email викликав `IntegrityError` без дружнього повідомлення | Перетворення на `serializers.ValidationError` з описом проблеми | ✅ Виправлено |
| 15 | `DishViewSet` парсери | B/D — Зовнішні залежності | API приймало лише `multipart/form-data`, JSON-клієнти отримували 415 | Додано `JSONParser`, запити без файлів обробляються коректно | ✅ Виправлено |
| 16 | 404 не обробляється окремо на клієнті | Немає if для 404 окремо від інших помилок | ??? | Користувач бачить незмістовне повідомлення про помилку | Low | ✅ Виправлено |

---

## 2. Приклади "До" і "Після"

### Проблема 1 і 4 — Відсутні таймаути у `api.js`

**До:**
```javascript
const apiClient = axios.create({
  baseURL: API_URL + VERSION,
});

// ... в interceptor ...
const response = await axios.post(API_URL + 'token/refresh/', {
  refresh: refreshToken
});
```

**Після:**
```
const apiClient = axios.create({
  baseURL: API_URL + VERSION,
  timeout: 10000, // 10 секунд
});

const response = await axios.post(API_URL + 'token/refresh/', {
  refresh: refreshToken
}, {
  timeout: 5000, // 5 секунд
});
```

### Патерн надійності:
- Timeout — обмеження часу виконання запиту, щоб уникнути зависань.

### Проблема 6 — Занадто широке перехоплення виключень
**До:**
```
except Exception as e:
    self.stderr.write(self.style.ERROR(f"Error creating manager: {e}"))
```

**Після:**
Так само. Що ми можемо зробити з помилкою, крім як залогувати її? Не зупиняти ж через це весь застосунок?


### Проблема 7 — Replace логіка без rollback у update_dish
**До:**
```
DishIngredient.objects.filter(dish=dish_instance).delete()
DishIngredient.objects.bulk_create(dish_ingredients)
```

**Після:**
***Краще видалити на фіг цю систему, вона не використовується.***
```
with transaction.atomic():
    DishIngredient.objects.filter(dish=dish_instance).delete()
    DishIngredient.objects.bulk_create(dish_ingredients)
```

#### 8, 9 Logout: валідація та таргетоване перехоплення винятків
- **Було.** `request.data["refresh"]` викидав `KeyError`, а загальний `except Exception` приховував системні збої.
- **Стало.** Впроваджено guard clause з `request.data.get("refresh")` і поверненням 400, а також перехоплення лише `TokenError` із логуванням.
- **Ефект.** Клієнт отримує чітку причину відмови, а несподівані помилки не губляться в логах.

#### 10 Створення початкового менеджера
- **Було.** Команда `create_initial_manager` логувала «Error creating manager» та продовжувала роботу, залишаючи систему без адміністратора.
- **Стало.** Конкретні винятки (`IntegrityError`, `ValidationError`) піднімаються повторно після логування, що зриває деплой із поясненням.
- **Ефект.** Неможливо випадково запустити систему без облікового запису менеджера.

#### 11, 12 Валідація категорій і інгредієнтів у стравах
- **Було.** `category_id` приймався як рядок; будь-який `"abc"` падав усередині ORM. Списки інгредієнтів не перевірялися на дублікати чи існування.
- **Стало.** `DishViewSet` переводить параметр у `int`, відхиляє нечислові/негативні значення; `_validate_ingredients_payload` гарантує унікальність і наявність кожного `ingredient_id` перед `bulk_create`.
- **Ефект.** Помилки користувача перетворюються на 400-відповіді з поясненням, база не отримує биті дані.

#### 13 Транзакційна цілісність при оновленні страви
- **Було.** `update_dish` видаляв усі записи й одразу створював нові; помилка між операціями залишала страву без інгредієнтів.
- **Стало.** Операція обгорнута у `@transaction.atomic`, тому при винятку виконання відкатується.
- **Ефект.** Страва не потрапляє в неконсистентний стан навіть при збої.

#### 14 Керування унікальністю email для менеджерів
- **Було.** `IntegrityError` при створенні користувача менеджером віддавав 500 без дружнього тексту.
- **Стало.** Помилка конвертується у `serializers.ValidationError` з чітким повідомленням про зайнятий email.
- **Ефект.** Менеджер одразу бачить, що адреса вже використовується, без падіння API.

#### 15 Підтримка JSON у `DishViewSet`
- **Було.** Парсер приймав лише multipart/form-data; клієнти без файлів отримували 415.
- **Стало.** Додано `JSONParser`, тому стандартні JSON-запити тепер успішно обробляються.
- **Ефект.** Менше «тихих» збоїв при інтеграції з мобільними або server-to-server клієнтами.
### Патерн надійності:
- Transaction — забезпечення цілісності даних при збої.

## 3. Опис застосованих патернів надійності

| Патерн | Призначення | Де застосовано |
| :-- | :-- | :-- |
| **Timeout** | Обмежує час очікування відповіді від зовнішніх сервісів | `api.js` — глобальний клієнт і refresh-токен |
| **Error Boundary / Fallback UI** | Запобігає падінню всього інтерфейсу | React UI (у планах) |
| **Guard Clause** | Забезпечує ранню перевірку даних | Перевірка `min` для ціни |
| **Fallback** | Використовує запасний варіант при збої | Завантаження зображень |
| **Targeted Catch** | Перехоплює лише очікувані типи помилок | `create_initial_manager.py` |
| **Transaction** | Захищає від неповних оновлень даних | `update_dish` у `services/dishes.py` |
| **Guard Clause** | Рання валідація вхідних даних | `LogoutView`, `DishViewSet.get_queryset` |
| **Targeted Catch** | Перехоплення лише очікуваних винятків | `LogoutView`, `create_initial_manager` |
| **Validation Layer** | Перевірка бізнес-правил до запису в БД | `_validate_ingredients_payload`, `ManagerUserCreateSerializer` |
| **Transaction** | Захист від часткових оновлень | `create_dish`, `update_dish` |
| **Graceful Degradation** | Коректна підтримка альтернативних форматів | `DishViewSet` (`JSONParser`) |

---

## 4. Відкриті проблеми та подальші кроки

| № | Опис | Ризик | Рекомендації |
| :-- | :-- | :-- | :-- |
| 5 | Завантаження зображень без fallback | Low | Додати запасне зображення при збої |
| 6 | Надто широке `except Exception` | Medium | Залишити тільки очікувані помилки (`IntegrityError`, `ValueError`, тощо) |
| 7 | Оновлення страв без rollback | High | Обгорнути оновлення у `transaction.atomic()` |

---

## 5. Висновки

Після аналізу коду виявлено 7 основних проблем, що впливають на **надійність та стійкість системи доставки**.  
Виправлені таймаути значно зменшили ризики зависання застосунку, однак залишаються відкритими питання валідації, UI-захисту та транзакційної цілісності.  

Подальша робота передбачає:
- Покращення валідації вхідних даних.  
- Впровадження додаткових reliability-тестів на 404, помилки бази даних та таймаути.
